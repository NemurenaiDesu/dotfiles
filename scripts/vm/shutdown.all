#!/bin/bash

running_vms=$(virsh list --name --state-running)

for vm in $running_vms; do
    echo -n "[$vm] Sending shutdown request..."
    virsh shutdown $vm > /dev/null
    echo " OK"
done

for vm in $running_vms; do
    echo -n "[$vm] Waiting for VM to shutdown..."
    while [ "$(virsh domstate $vm)" != "shut off" ]; do
        sleep 1
    done
    echo " OK"
done
